{{ define "main" }}
<article class="lesson-post">

  <h1>{{ .Title }}</h1>
  {{ if .Params.date }}
    <p><em>{{ .Date.Format "2 January 2006" }}</em></p>
  {{ end }}

  {{ $content := .RawContent }}

  {{ range .Params.structure }}
    {{- $type := .type }}
    {{- $ref := .ref }}

    {{- if eq $type "text" }}
      {{ $marker := printf "<!-- %s -->" $ref }}
      {{ $parts := split $content $marker }}
      {{ if ge (len $parts) 2 }}
        <div class="lesson-block lesson-text">
          {{ index $parts 1 | markdownify }}
        </div>
      {{ else }}
        <div class="missing-block">Missing marker for '{{ $ref }}'</div>
      {{ end }}

    {{- else if eq $type "scaffold" }}
      {{ $scaffold := site.GetPage (printf "scaffolds/%s" $ref) }}
      {{ if $scaffold }}
        <div class="lesson-block scaffold-block">
          {{ $scaffold.Content }}
        </div>
      {{ else }}
        <div class="missing-block">Missing scaffold '{{ $ref }}'</div>
      {{ end }}

    {{- else if eq $type "reflection" }}
      {{ $reflection := site.GetPage (printf "scaffolds/%s" $ref) }}
      {{ if $reflection }}
        <div class="lesson-block reflection-block">
          {{ $reflection.Content }}
        </div>
      {{ else }}
        <div class="missing-block">Missing reflection '{{ $ref }}'</div>
      {{ end }}
    {{ end }}
  {{ end }}

</article>
{{ end }}
