{{ define "main" }}
<article class="lesson-post">

  <h1>{{ .Title }}</h1>
  {{ partial "post_meta.html" . }}

  {{ $content := .RawContent }}

  {{ range .Params.structure }}
    {{- $type := .type }}
    {{- $ref := .ref }}

    {{- if eq $type "text" }}
      {{ $marker := printf "<!-- %s -->" $ref }}
      {{ $split := split $content $marker }}
      {{ if ge (len $split) 2 }}
        <div class="lesson-block lesson-text">
          {{ index $split 1 | markdownify }}
        </div>
      {{ else }}
        <div class="missing-block">⚠️ Marker not found for <code>{{ $ref }}</code></div>
      {{ end }}

    {{- else if eq $type "scaffold" }}
      {{ $scaffold := site.GetPage (printf "scaffolds/%s" $ref) }}
      {{ if $scaffold }}
        <div class="lesson-block scaffold-block">
          {{ $scaffold.Content }}
        </div>
      {{ else }}
        <div class="missing-block">⚠️ Missing scaffold <code>{{ $ref }}</code></div>
      {{ end }}

    {{- else if eq $type "reflection" }}
      {{ $reflection := site.GetPage (printf "scaffolds/%s" $ref) }}
      {{ if $reflection }}
        <div class="lesson-block reflection-block">
          {{ $reflection.Content }}
        </div>
      {{ else }}
        <div class="missing-block">⚠️ Missing reflection <code>{{ $ref }}</code></div>
      {{ end }}
    {{ end }}
  {{ end }}

</article>
{{ end }}
